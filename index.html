import csv
import json
import os

# --- [ì„¤ì •] íŒŒì¼ëª… ì„¤ì • ---
# â˜… ë°˜ë“œì‹œ íŒŒì¼ì„ 'data.csv'ë¡œ ì €ì¥í•˜ê³  ì‹¤í–‰í•˜ì„¸ìš”.
input_filename = 'data.csv'
output_filename = 'index.html'

# --- [1] ë°ì´í„° ì½ê¸° ë° ì „ì²˜ë¦¬ ---
news_data = []

print(f"ğŸ”„ '{input_filename}' íŒŒì¼ì„ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...")

try:
    # utf-8-sig: ì—‘ì…€ì—ì„œ ì €ì¥í•œ CSVì˜ í•œê¸€ ê¹¨ì§ ë°©ì§€
    with open(input_filename, mode='r', encoding='utf-8-sig') as csvfile:
        reader = csv.DictReader(csvfile)
        
        # ì»¬ëŸ¼ëª… ê³µë°± ì œê±° (ì˜¤ë¥˜ ë°©ì§€)
        if reader.fieldnames:
            reader.fieldnames = [h.strip() for h in reader.fieldnames]

        for row in reader:
            # ì•ˆì „í•˜ê²Œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            keyword = row.get('keyword', '').strip()
            title = row.get('title', '').strip()
            link = row.get('link', '').strip()
            if not link: link = "#" # ë§í¬ ì—†ìœ¼ë©´ # ì²˜ë¦¬
            
            # ë‚ ì§œ ì²˜ë¦¬ (date_fmtê°€ ì—†ìœ¼ë©´ date ì‚¬ìš©)
            date = row.get('date_fmt', row.get('date', '')).strip()
            if not date: date = "ë‚ ì§œ ë¯¸ìƒ"
            
            # ë¦¬ìŠ¤í¬ ë“±ê¸‰ ì²˜ë¦¬
            risk = row.get('risk', 'GREEN').strip().upper()
            if risk not in ['RED', 'AMBER', 'GREEN']:
                risk = 'GREEN'

            if title: # ì œëª©ì´ ìˆëŠ” ë°ì´í„°ë§Œ ì¶”ê°€
                news_data.append({
                    "keyword": keyword,
                    "title": title,
                    "link": link,
                    "date": date,
                    "risk": risk
                })

    print(f"âœ… ì„±ê³µ! ì´ {len(news_data)}ê°œì˜ ë‰´ìŠ¤ë¥¼ ì½ì—ˆìŠµë‹ˆë‹¤.")

except FileNotFoundError:
    print(f"âŒ ì˜¤ë¥˜: '{input_filename}' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    print("ğŸ‘‰ ì—‘ì…€ íŒŒì¼ì„ 'ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì €ì¥' -> 'CSV (UTF-8)' ì„ íƒ -> íŒŒì¼ëª… 'data.csv'ë¡œ ì €ì¥í•´ì£¼ì„¸ìš”.")
except Exception as e:
    print(f"âŒ ë°ì´í„° ì½ê¸° ì˜¤ë¥˜: {e}")

# --- [ë¹„ìƒìš©] ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì½ê¸° ì‹¤íŒ¨ ì‹œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚¬ìš© ---
if len(news_data) == 0:
    print("âš ï¸ ë°ì´í„°ë¥¼ ì½ì§€ ëª»í•´ 'í…ŒìŠ¤íŠ¸ ë°ì´í„°'ë¡œ ëŒ€ì‹œë³´ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.")
    news_data = [
        {"keyword": "ì‹œìŠ¤í…œ", "title": "data.csv íŒŒì¼ì„ ì½ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.", "link": "#", "date": "2025-01-01", "risk": "RED"},
        {"keyword": "KT", "title": "[ì˜ˆì‹œ] KT ì°¨ê¸° CEO ë°•ìœ¤ì˜ ë‚´ì •, ê²½ì˜ ì •ìƒí™” ì‹œë™", "link": "#", "date": "2025-12-16", "risk": "GREEN"},
        {"keyword": "SKì‰´ë”ìŠ¤", "title": "[ì˜ˆì‹œ] SKì‰´ë”ìŠ¤ í•´í‚¹ ì´ìŠˆ, ê³ ê° ì •ë³´ ìœ ì¶œ ìš°ë ¤", "link": "#", "date": "2025-10-27", "risk": "RED"},
    ]

# JSON ë³€í™˜
json_data = json.dumps(news_data, ensure_ascii=False)

# --- [2] HTML í…œí”Œë¦¿ (ì „ë¬¸ê°€ìš© ë””ìì¸) ---
html_content = f"""
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Insight Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {{ font-family: 'Noto Sans KR', sans-serif; background-color: #f1f5f9; }}
        .glass-card {{ background: white; border: 1px solid #cbd5e1; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border-radius: 12px; }}
        .glass-card:hover {{ transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transition: all 0.2s; }}
        .badge-RED {{ background: #fef2f2; color: #991b1b; border: 1px solid #fca5a5; }}
        .badge-AMBER {{ background: #fffbeb; color: #92400e; border: 1px solid #fcd34d; }}
        .badge-GREEN {{ background: #f0fdf4; color: #166534; border: 1px solid #86efac; }}
    </style>
</head>
<body class="text-slate-800">

    <nav class="bg-slate-900 text-white sticky top-0 z-50 shadow-md">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between max-w-7xl">
            <div class="flex items-center gap-3">
                <i class="ph-fill ph-shield-check text-2xl text-blue-400"></i>
                <h1 class="text-lg font-bold">Security Analysis</h1>
            </div>
            <div class="text-xs text-slate-400 font-mono">
                DATA: {input_filename}
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6 max-w-7xl">
        
        <div class="glass-card p-6 mb-6 bg-gradient-to-br from-slate-800 to-slate-900 text-white border-none">
            <div class="flex items-start gap-4">
                <div class="p-3 bg-white/10 rounded-lg"><i class="ph-duotone ph-robot text-3xl text-blue-300"></i></div>
                <div>
                    <h2 class="text-lg font-bold mb-2 text-white">ì„ì›ìš© AI ì¸ì‚¬ì´íŠ¸ ìš”ì•½</h2>
                    <p class="text-sm text-slate-300 leading-relaxed">
                        ìµœê·¼ <strong>KT, SKì‰´ë”ìŠ¤, ì—ìŠ¤ì›</strong> ë“±ì˜ ë³´ì•ˆ ì´ìŠˆê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. 
                        íŠ¹íˆ <span class="text-red-300 font-bold">RED ë“±ê¸‰</span>(í•´í‚¹, ì‚¬ê³  ë“±) ì´ìŠˆëŠ” ì¦‰ê°ì ì¸ ëŒ€ì‘ì´ í•„ìš”í•˜ë©°, 
                        í•˜ë‹¨ ì°¨íŠ¸ë¥¼ í†µí•´ ì¼ë³„ íŠ¸ë Œë“œì™€ ë¦¬ìŠ¤í¬ ì ìœ ìœ¨ì„ í™•ì¸í•˜ì‹­ì‹œì˜¤.
                    </p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="glass-card p-4 border-l-4 border-blue-500">
                <span class="text-xs font-bold text-slate-500">ì „ì²´ ë‰´ìŠ¤</span>
                <p class="text-3xl font-bold mt-1" id="kpi-total">0</p>
            </div>
            <div class="glass-card p-4 border-l-4 border-red-500 bg-red-50/50">
                <span class="text-xs font-bold text-red-700">ì‹¬ê° (Critical)</span>
                <p class="text-3xl font-bold mt-1 text-red-600" id="kpi-red">0</p>
            </div>
            <div class="glass-card p-4 border-l-4 border-amber-500">
                <span class="text-xs font-bold text-amber-700">ì£¼ì˜ (Warning)</span>
                <p class="text-3xl font-bold mt-1 text-amber-600" id="kpi-amber">0</p>
            </div>
            <div class="glass-card p-4 border-l-4 border-green-500">
                <span class="text-xs font-bold text-green-700">ì£¼ìš” í‚¤ì›Œë“œ</span>
                <p class="text-xl font-bold mt-2 text-green-700 truncate" id="kpi-keyword">-</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="space-y-6">
                <div class="glass-card p-5">
                    <h3 class="font-bold text-slate-700 mb-4 text-sm"><i class="ph-fill ph-faders"></i> í•„í„° ë° ê²€ìƒ‰</h3>
                    <select id="filter-keyword" class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm mb-3 outline-none focus:border-blue-500">
                        <option value="all">ì „ì²´ í‚¤ì›Œë“œ</option>
                    </select>
                    <input type="text" id="filter-search" placeholder="ì œëª© ê²€ìƒ‰..." class="w-full p-2.5 bg-slate-50 border rounded-lg text-sm outline-none focus:border-blue-500">
                </div>
                
                <div class="glass-card p-5">
                    <h3 class="font-bold text-slate-700 mb-4 text-sm"><i class="ph-fill ph-chart-pie-slice"></i> ë¦¬ìŠ¤í¬ ë¹„ìœ¨</h3>
                    <div class="h-48 relative"><canvas id="riskChart"></canvas></div>
                </div>

                 <div class="glass-card p-5">
                    <h3 class="font-bold text-slate-700 mb-4 text-sm"><i class="ph-fill ph-trend-up"></i> ë°œìƒ ì¶”ì´</h3>
                    <div class="h-40 relative"><canvas id="trendChart"></canvas></div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="flex justify-between items-end mb-3">
                    <h3 class="font-bold text-lg text-slate-800">ìƒì„¸ ë‰´ìŠ¤ í”¼ë“œ</h3>
                    <span id="list-count" class="text-xs font-bold bg-white px-2 py-1 rounded border shadow-sm">Total: 0</span>
                </div>
                <div id="news-list" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script>
        const rawData = {json_data};
        let filteredData = [...rawData];

        function init() {{
            const sel = document.getElementById('filter-keyword');
            const keys = [...new Set(rawData.map(d => d.keyword))].filter(k=>k).sort();
            keys.forEach(k => {{
                const opt = document.createElement('option');
                opt.value = k;
                opt.textContent = k;
                sel.appendChild(opt);
            }});
            update();
        }}

        function update() {{
            const kVal = document.getElementById('filter-keyword').value;
            const sVal = document.getElementById('filter-search').value.toLowerCase();
            
            filteredData = rawData.filter(d => {{
                return (kVal === 'all' || d.keyword === kVal) && d.title.toLowerCase().includes(sVal);
            }});

            renderKPI();
            renderList();
            renderCharts();
        }}

        function renderKPI() {{
            document.getElementById('kpi-total').textContent = filteredData.length;
            document.getElementById('kpi-red').textContent = filteredData.filter(d=>d.risk==='RED').length;
            document.getElementById('kpi-amber').textContent = filteredData.filter(d=>d.risk==='AMBER').length;
            
            if(filteredData.length > 0) {{
                const counts = {{}};
                filteredData.forEach(d=> counts[d.keyword] = (counts[d.keyword]||0)+1);
                document.getElementById('kpi-keyword').textContent = Object.keys(counts).reduce((a,b)=>counts[a]>counts[b]?a:b);
            }} else {{
                document.getElementById('kpi-keyword').textContent = "-";
            }}
            document.getElementById('list-count').textContent = `ê²€ìƒ‰ê²°ê³¼: ${{filteredData.length}}ê±´`;
        }}

        function renderList() {{
            const con = document.getElementById('news-list');
            con.innerHTML = '';
            
            if(filteredData.length === 0) {{
                con.innerHTML = '<div class="p-12 text-center text-slate-400 bg-white rounded-xl border border-dashed">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }}

            filteredData.forEach(item => {{
                const el = document.createElement('a');
                el.href = item.link;
                el.target = '_blank';
                el.className = 'block glass-card p-5 hover:border-blue-400 group relative no-underline';
                const badge = `badge-${{item.risk}}`;
                
                el.innerHTML = `
                    <div class="flex justify-between items-start gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2 flex-wrap">
                                <span class="text-[10px] font-bold px-2 py-0.5 rounded border uppercase ${{badge}}">${{item.risk}}</span>
                                <span class="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-0.5 rounded border">${{item.keyword}}</span>
                                <span class="text-xs text-slate-400 flex items-center gap-1"><i class="ph-bold ph-calendar"></i> ${{item.date}}</span>
                            </div>
                            <h4 class="font-bold text-slate-800 text-base leading-snug group-hover:text-blue-600 transition-colors">${{item.title}}</h4>
                        </div>
                        <i class="ph-bold ph-arrow-square-out text-slate-300 text-lg group-hover:text-blue-500"></i>
                    </div>
                `;
                con.appendChild(el);
            }});
        }}

        let chRisk = null, chTrend = null;
        function renderCharts() {{
            const counts = {{'RED':0, 'AMBER':0, 'GREEN':0}};
            const dates = {{}};
            filteredData.forEach(d => {{
                if(counts[d.risk]!==undefined) counts[d.risk]++; else counts['GREEN']++;
                dates[d.date] = (dates[d.date]||0)+1;
            }});

            // Risk Chart
            const ctxR = document.getElementById('riskChart').getContext('2d');
            if(chRisk) chRisk.destroy();
            chRisk = new Chart(ctxR, {{
                type: 'doughnut',
                data: {{
                    labels: ['Red', 'Amber', 'Green'],
                    datasets: [{{ data: [counts['RED'], counts['AMBER'], counts['GREEN']], backgroundColor: ['#ef4444', '#f59e0b', '#22c55e'], borderWidth: 0 }}]
                }},
                options: {{ responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: {{ legend: {{ position: 'right', labels: {{ boxWidth: 10, font: {{ size: 11 }} }} }} }} }}
            }});

            // Trend Chart
            const sortedDates = Object.keys(dates).sort();
            const ctxT = document.getElementById('trendChart').getContext('2d');
            if(chTrend) chTrend.destroy();
            chTrend = new Chart(ctxT, {{
                type: 'line',
                data: {{
                    labels: sortedDates,
                    datasets: [{{
                        label: 'ê¸°ì‚¬ ìˆ˜',
                        data: sortedDates.map(d=>dates[d]),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2
                    }}]
                }},
                options: {{
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {{ legend: {{ display: false }} }},
                    scales: {{ x: {{ display: false }}, y: {{ beginAtZero: true, display: false }} }}
                }}
            }});
        }}

        document.getElementById('filter-keyword').addEventListener('change', update);
        document.getElementById('filter-search').addEventListener('input', update);
        init();
    </script>
</body>
</html>
"""

with open(output_filename, 'w', encoding='utf-8') as f:
    f.write(html_content)

print(f"âœ¨ ì™„ë£Œ! '{output_filename}' íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
print("1. ìƒì„±ëœ index.htmlì„ ê¹ƒí—ˆë¸Œì— ì—…ë¡œë“œí•˜ì„¸ìš”.")
print("2. https://bough38-web.github.io/retention-dashboard/ ì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.")
