import csv
import json
import os

# 1. ë°ì´í„° íŒŒì¼ ì½ê¸° (ì—…ë¡œë“œëœ íŒŒì¼ëª… ê¸°ì¤€)
input_filename = '01_á„‡á…©á„‹á…¡á†«á„‹á…¡á†«á„Œá…¥á†«_á„‰á…¡á†¼á„‰á…¦á„‚á…¢á„‹á…§á†¨.xlsx - Sheet1.csv'
output_filename = 'index.html' # ê¹ƒí—ˆë¸Œ ë°°í¬ë¥¼ ìœ„í•´ index.htmlë¡œ ì €ì¥

# ë°ì´í„° ì €ì¥ì†Œ
news_data = []

# CSV íŒŒì¼ ì½ê¸° ë° ë°ì´í„° ê°€ê³µ
try:
    with open(input_filename, mode='r', encoding='utf-8') as csvfile:
        reader = csv.DictReader(csvfile)
        for row in reader:
            news_data.append({
                "keyword": row.get('keyword', '').strip(),
                "title": row.get('title', '').strip(),
                "link": row.get('link', '').strip(),
                "date": row.get('date_fmt', '').strip(), # YYYY-MM-DD í˜•ì‹ ì‚¬ìš©
                "full_date": row.get('date', '').strip(),
                "risk": row.get('risk', 'GREEN').strip().upper()
            })
except FileNotFoundError:
    print(f"ì˜¤ë¥˜: '{input_filename}' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
    # í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ë°ì´í„° (íŒŒì¼ì´ ì—†ì„ ê²½ìš° ì‘ë™ í™•ì¸ìš©)
    news_data = [
        {"keyword": "KT", "title": "KT ì°¨ê¸° CEO ë°•ìœ¤ì˜ ë‚´ì •... ê²½ì˜ ì •ìƒí™” ì‹œë™", "date": "2025-12-16", "risk": "GREEN", "link": "#"},
        {"keyword": "SKì‰´ë”ìŠ¤", "title": "SKì‰´ë”ìŠ¤ í•´í‚¹ ì´ìŠˆ, ê°œì¸ì •ë³´ ìœ ì¶œ ìš°ë ¤ í™•ì‚°", "date": "2025-10-27", "risk": "RED", "link": "#"},
    ]

# JSON ë³€í™˜ (ìë°”ìŠ¤í¬ë¦½íŠ¸ ë‚´ì¥ìš©)
json_data = json.dumps(news_data, ensure_ascii=False)

# 2. HTML í…œí”Œë¦¿ ì‘ì„± (Tailwind CSS + Chart.js ì ìš©)
html_content = f"""
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë³´ì•ˆ/ì•ˆì „ ë‰´ìŠ¤ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body {{ font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; background-color: #f3f4f6; }}
        .card {{ background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: transform 0.2s; }}
        .card:hover {{ transform: translateY(-2px); }}
        .risk-badge-RED {{ background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }}
        .risk-badge-AMBER {{ background-color: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; }}
        .risk-badge-GREEN {{ background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }}
    </style>
</head>
<body class="text-gray-800">

    <nav class="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="ph ph-shield-check text-3xl text-blue-400"></i>
                <div>
                    <h1 class="text-xl font-bold">Security Analysis Dashboard</h1>
                    <p class="text-xs text-slate-400">ë³´ì•ˆ/ì•ˆì „ ë‰´ìŠ¤ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</p>
                </div>
            </div>
            <div class="hidden md:flex gap-4 text-sm">
                <span class="px-3 py-1 bg-slate-800 rounded-full">ë°ì´í„° ì—…ë°ì´íŠ¸: 2025-12-16</span>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-7xl">
        
        <div class="bg-gradient-to-r from-blue-900 to-indigo-900 rounded-2xl p-6 text-white mb-8 shadow-xl">
            <div class="flex items-start gap-4">
                <div class="p-3 bg-white/10 rounded-lg">
                    <i class="ph ph-robot text-3xl text-yellow-300"></i>
                </div>
                <div>
                    <h2 class="text-lg font-bold mb-2 flex items-center gap-2">AI ì„ì› ìš”ì•½ ë¦¬í¬íŠ¸ <span class="text-xs font-normal bg-blue-600 px-2 py-0.5 rounded">Auto-Generated</span></h2>
                    <p class="text-blue-100 leading-relaxed text-sm md:text-base">
                        <strong>[ì¢…í•©]</strong> ìµœê·¼ ë°ì´í„° ë¶„ì„ ê²°ê³¼, ê°€ì¥ í™”ì œê°€ ëœ í‚¤ì›Œë“œëŠ” <strong>KT</strong>ì™€ <strong>SKì‰´ë”ìŠ¤</strong>ì…ë‹ˆë‹¤.<br>
                        <strong>â€¢ KT (ê¸ì •/ì¤‘ë¦½):</strong> ë°•ìœ¤ì˜ ì „ ì‚¬ì¥ì´ ì°¨ê¸° CEO ìµœì¢… í›„ë³´ë¡œ í™•ì •ë˜ë©° ê²½ì˜ ì•ˆì •í™”ì— ëŒ€í•œ ê¸°ëŒ€ê°ìœ¼ë¡œ ê¸ì •ì  ì—¬ë¡ ì´ í˜•ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (Risk: Low)<br>
                        <strong>â€¢ SKì‰´ë”ìŠ¤ (ë¶€ì •):</strong> í•´í‚¹ ì‚¬ê³ ë¡œ ì¸í•œ 120ê°œ ê³ ê°ì‚¬ ì •ë³´ ìœ ì¶œ ì´ìŠˆê°€ ì§€ì†ë˜ë©° 'RED' ë¦¬ìŠ¤í¬ê°€ ê¸‰ì¦í–ˆìŠµë‹ˆë‹¤. ì¦‰ê°ì ì¸ ëŒ€ì‘ ëª¨ë‹ˆí„°ë§ì´ í•„ìš”í•©ë‹ˆë‹¤.<br>
                        <strong>â€¢ ì—ìŠ¤ì›/KTí…”ë ˆìº…:</strong> ì§€ìì²´ í˜‘ë ¥ ë° AI ì•ˆì „ ì†”ë£¨ì…˜ ê´€ë ¨ í™ë³´ì„± ê¸°ì‚¬ê°€ ì£¼ë¥¼ ì´ë£¨ë©° ì•ˆì •ì ì¸ í‰íŒì„ ìœ ì§€ ì¤‘ì…ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="card p-5 border-l-4 border-blue-500">
                <p class="text-gray-500 text-sm font-medium">ì´ ë¶„ì„ ê¸°ì‚¬</p>
                <p class="text-3xl font-bold mt-1" id="total-count">-</p>
            </div>
            <div class="card p-5 border-l-4 border-red-500">
                <p class="text-gray-500 text-sm font-medium">ìœ„ê¸°(Critical) ê°ì§€</p>
                <p class="text-3xl font-bold mt-1 text-red-600" id="critical-count">-</p>
            </div>
            <div class="card p-5 border-l-4 border-yellow-500">
                <p class="text-gray-500 text-sm font-medium">ì£¼ì˜(Warning) ê°ì§€</p>
                <p class="text-3xl font-bold mt-1 text-yellow-600" id="warning-count">-</p>
            </div>
            <div class="card p-5 border-l-4 border-green-500">
                <p class="text-gray-500 text-sm font-medium">ìµœë‹¤ ì–¸ê¸‰ í‚¤ì›Œë“œ</p>
                <p class="text-2xl font-bold mt-1 text-green-700 truncate" id="top-keyword">-</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="card p-6 lg:col-span-2">
                <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                    <i class="ph ph-trend-up"></i> ì¼ë³„ ë‰´ìŠ¤ íŠ¸ë Œë“œ
                </h3>
                <canvas id="trendChart" height="250"></canvas>
            </div>
            
            <div class="card p-6">
                <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                    <i class="ph ph-chart-pie-slice"></i> ë¦¬ìŠ¤í¬ ë¶„í¬
                </h3>
                <div class="relative h-64">
                    <canvas id="riskChart"></canvas>
                </div>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-6">
            <div class="w-full md:w-64 shrink-0 space-y-4">
                <div class="card p-5 sticky top-24">
                    <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">í•„í„°ë§ ì˜µì…˜</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-600 mb-1">í‚¤ì›Œë“œ ì„ íƒ</label>
                        <select id="keyword-filter" class="w-full p-2 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="all">ì „ì²´ ë³´ê¸°</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-600 mb-1">ë¦¬ìŠ¤í¬ ë ˆë²¨</label>
                        <select id="risk-filter" class="w-full p-2 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="all">ì „ì²´ ë“±ê¸‰</option>
                            <option value="RED">ğŸš¨ ìœ„ê¸° (RED)</option>
                            <option value="AMBER">âš ï¸ ì£¼ì˜ (AMBER)</option>
                            <option value="GREEN">âœ… ì–‘í˜¸ (GREEN)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">ê²€ìƒ‰ì–´</label>
                        <input type="text" id="search-input" placeholder="ì œëª© ê²€ìƒ‰..." class="w-full p-2 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
            </div>

            <div class="flex-1">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-xl text-gray-800">ìƒì„¸ ë‰´ìŠ¤ ë¦¬ìŠ¤íŠ¸</h3>
                    <span id="filtered-count" class="text-sm text-gray-500">Total: 0ê±´</span>
                </div>
                <div id="news-container" class="space-y-3">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // 1. Embedded Data from Python
        const rawData = {json_data};

        // 2. State & Init
        let currentData = [...rawData];
        
        // DOM Elements
        const container = document.getElementById('news-container');
        const totalCountEl = document.getElementById('total-count');
        const criticalCountEl = document.getElementById('critical-count');
        const warningCountEl = document.getElementById('warning-count');
        const topKeywordEl = document.getElementById('top-keyword');
        const filteredCountEl = document.getElementById('filtered-count');
        
        const keywordFilter = document.getElementById('keyword-filter');
        const riskFilter = document.getElementById('risk-filter');
        const searchInput = document.getElementById('search-input');

        // 3. Initialize Filters
        function initFilters() {{
            const keywords = [...new Set(rawData.map(item => item.keyword))].filter(k => k);
            keywords.forEach(k => {{
                const option = document.createElement('option');
                option.value = k;
                option.textContent = k.toUpperCase();
                keywordFilter.appendChild(option);
            }});
        }}

        // 4. Render Functions
        function renderKPIs(data) {{
            totalCountEl.textContent = data.length.toLocaleString();
            criticalCountEl.textContent = data.filter(i => i.risk === 'RED').length.toLocaleString();
            warningCountEl.textContent = data.filter(i => i.risk === 'AMBER').length.toLocaleString();
            
            // Find top keyword
            if(data.length === 0) {{
                topKeywordEl.textContent = "-";
                return;
            }}
            const counts = {{}};
            data.forEach(x => {{ counts[x.keyword] = (counts[x.keyword] || 0) + 1; }});
            const top = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
            topKeywordEl.textContent = top.toUpperCase();
        }}

        function renderList(data) {{
            container.innerHTML = '';
            filteredCountEl.textContent = `Total: ${{data.length}}ê±´`;

            if (data.length === 0) {{
                container.innerHTML = '<div class="p-8 text-center text-gray-400">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }}

            data.forEach(item => {{
                const el = document.createElement('div');
                el.className = 'card p-4 hover:bg-gray-50 cursor-pointer group';
                el.onclick = () => window.open(item.link, '_blank');
                
                const riskClass = `risk-badge-${{item.risk}}` || 'risk-badge-GREEN';
                
                el.innerHTML = `
                    <div class="flex justify-between items-start gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold px-2 py-0.5 rounded border uppercase ${{riskClass}}">${{item.risk}}</span>
                                <span class="text-xs font-semibold text-blue-600 bg-blue-50 px-2 py-0.5 rounded border border-blue-100">${{item.keyword.toUpperCase()}}</span>
                                <span class="text-xs text-gray-400">${{item.date}}</span>
                            </div>
                            <h4 class="font-bold text-gray-800 group-hover:text-blue-600 transition-colors leading-snug">${{item.title}}</h4>
                        </div>
                        <i class="ph ph-arrow-square-out text-gray-300 group-hover:text-blue-500"></i>
                    </div>
                `;
                container.appendChild(el);
            }});
        }}

        // 5. Chart Rendering
        let trendChartInstance = null;
        let riskChartInstance = null;

        function renderCharts(data) {{
            // Process Data for Charts
            const dateCounts = {{}};
            const riskCounts = {{ 'RED': 0, 'AMBER': 0, 'GREEN': 0 }};

            data.forEach(item => {{
                // Trend
                const d = item.date;
                dateCounts[d] = (dateCounts[d] || 0) + 1;
                // Risk
                if (riskCounts[item.risk] !== undefined) {{
                    riskCounts[item.risk]++;
                }} else {{
                    riskCounts['GREEN']++; // fallback
                }}
            }});

            const sortedDates = Object.keys(dateCounts).sort();
            const trendData = sortedDates.map(d => dateCounts[d]);

            // 1. Trend Chart
            const ctxTrend = document.getElementById('trendChart').getContext('2d');
            if (trendChartInstance) trendChartInstance.destroy();
            
            trendChartInstance = new Chart(ctxTrend, {{
                type: 'line',
                data: {{
                    labels: sortedDates,
                    datasets: [{{
                        label: 'ì¼ë³„ ê¸°ì‚¬ëŸ‰',
                        data: trendData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3,
                        fill: true
                    }}]
                }},
                options: {{
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {{ legend: {{ display: false }} }},
                    scales: {{
                        y: {{ beginAtZero: true, grid: {{ display: false }} }},
                        x: {{ grid: {{ display: false }} }}
                    }}
                }}
            }});

            // 2. Risk Chart
            const ctxRisk = document.getElementById('riskChart').getContext('2d');
            if (riskChartInstance) riskChartInstance.destroy();

            riskChartInstance = new Chart(ctxRisk, {{
                type: 'doughnut',
                data: {{
                    labels: ['ìœ„ê¸° (Red)', 'ì£¼ì˜ (Amber)', 'ì–‘í˜¸ (Green)'],
                    datasets: [{{
                        data: [riskCounts['RED'], riskCounts['AMBER'], riskCounts['GREEN']],
                        backgroundColor: ['#ef4444', '#f59e0b', '#22c55e'],
                        borderWidth: 0
                    }}]
                }},
                options: {{
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {{
                        legend: {{ position: 'right' }}
                    }}
                }}
            }});
        }}

        // 6. Filter Logic
        function filterData() {{
            const keyVal = keywordFilter.value;
            const riskVal = riskFilter.value;
            const searchVal = searchInput.value.toLowerCase();

            const filtered = rawData.filter(item => {{
                const matchKey = keyVal === 'all' || item.keyword === keyVal;
                const matchRisk = riskVal === 'all' || item.risk === riskVal;
                const matchSearch = item.title.toLowerCase().includes(searchVal);
                return matchKey && matchRisk && matchSearch;
            }});

            currentData = filtered;
            renderKPIs(currentData);
            renderList(currentData);
            renderCharts(currentData);
        }}

        // Event Listeners
        keywordFilter.addEventListener('change', filterData);
        riskFilter.addEventListener('change', filterData);
        searchInput.addEventListener('input', filterData);

        // Initial Run
        initFilters();
        filterData(); // This triggers initial render

    </script>
</body>
</html>
"""

# HTML íŒŒì¼ ì €ì¥
with open(output_filename, 'w', encoding='utf-8') as f:
    f.write(html_content)

print(f"ì„±ê³µ: '{output_filename}' íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
print("ì´ íŒŒì¼ì„ ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œì— ì—…ë¡œë“œí•˜ê³  GitHub Pagesë¥¼ í™œì„±í™”í•˜ë©´ ëŒ€ì‹œë³´ë“œê°€ ë°°í¬ë©ë‹ˆë‹¤.")