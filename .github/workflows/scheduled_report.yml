# .github/workflows/scheduled_report.yml

name: Scheduled Security Report Generation

# 1. 실행 조건 설정 (스케줄 및 수동 실행)
on:
  schedule:
    # 한국 시간(KST) 오전 9시에 실행 (UTC 0시)
    - cron: '0 0 * * *' 
    
  # 수동 실행을 위한 버튼 추가 (Actions 탭에서 즉시 실행 가능)
  workflow_dispatch: 

jobs:
  run_report_system:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code (코드 가져오기)
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10' 

    - name: Install dependencies (필요한 라이브러리 설치)
      run: |
        # win32com(Outlook)을 제외한 모든 라이브러리 설치
        # xlrd는 openpyxl이 대체하므로 삭제했습니다.
        pip install pandas openai python-pptx feedparser openpyxl

    - name: Set up AI Key (비밀 변수 로드)
      # Settings > Secrets에 등록한 OPENAI_API_KEY를 환경 변수로 설정합니다.
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        echo "API Key loaded."

    - name: Run Report System (메인 스크립트 실행)
      # ⚠️ 수정된 부분: python main.py로 변경
      # 이 방식이 main 모듈을 더 안정적으로 찾을 수 있습니다.
      run: |
        python main.py

    - name: Upload Report Artifacts (결과물 저장)
      # 생성된 Excel/PPT/Zip 파일을 다운로드할 수 있도록 보관
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-${{ github.sha }}
        path: output/
        retention-days: 7
